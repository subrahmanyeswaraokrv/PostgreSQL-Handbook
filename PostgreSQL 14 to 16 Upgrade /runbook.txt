root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# psql -V
psql (PostgreSQL) 14.17 (Ubuntu 14.17-0ubuntu0.22.04.1)
root@qa-mongo3:~#
root@qa-mongo3:~# pg_dumpall > /tmp/pg14_full_backup.sql
-bash: /tmp/pg14_full_backup.sql: Permission denied
root@qa-mongo3:~#
root@qa-mongo3:~# pg_dumpall > /tmp/pg14_full_backup_16april25.sql
pg_dumpall: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  role "root" does not exist
root@qa-mongo3:~# sudo -u postgres pg_dumpall > /tmp/pg14_full_backup_16april25.sql
could not change directory to "/root": Permission denied
root@qa-mongo3:~# pg_dumpall -U postgres > /tmp/pg14_full_backup_16april-25.sql
pg_dumpall: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "postgres"
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ pg_dumpall > /tmp/pg14_full_backup_16april25.sql
-bash: /tmp/pg14_full_backup_16april25.sql: Permission denied
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup.sql
-rw-rw-r-- 1 postgres postgres 16M Apr 16 15:55 /tmp/pg14_full_backup.sql
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup_16april25.sql
-rw-r--r-- 1 root root 16M Apr 16 16:01 /tmp/pg14_full_backup_16april25.sql
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup_16april-25.sql
-rw-r--r-- 1 root root 0 Apr 16 16:02 /tmp/pg14_full_backup_16april-25.sql
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ sudo cp -av /etc/postgresql/14/main/postgresql.conf /etc/postgresql/14/main/postgresql.conf.bak
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/postgresql.conf /etc/postgresql/14/main/postgresql.conf.bak
'/etc/postgresql/14/main/postgresql.conf' -> '/etc/postgresql/14/main/postgresql.conf.bak'
root@qa-mongo3:~# ls -lh  /etc/postgresql/14/main/postgresql.conf.bak
-rw-r--r-- 1 postgres postgres 29K Mar 13 16:33 /etc/postgresql/14/main/postgresql.conf.bak
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/pg_hba.conf     /etc/postgresql/14/main/pg_hba.conf.bak
'/etc/postgresql/14/main/pg_hba.conf' -> '/etc/postgresql/14/main/pg_hba.conf.bak'
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/pg_ident.conf   /etc/postgresql/14/main/pg_ident.conf.bak
'/etc/postgresql/14/main/pg_ident.conf' -> '/etc/postgresql/14/main/pg_ident.conf.bak'
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl stop postgresql
root@qa-mongo3:~#
root@qa-mongo3:~# sudo apt update
Get:1 http://security.ubuntu.com/ubuntu jammy-security InRelease [129 kB]
Hit:2 http://archive.ubuntu.com/ubuntu jammy InRelease
Hit:3 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease
Get:4 http://archive.ubuntu.com/ubuntu jammy-updates InRelease [128 kB]
Hit:5 https://repo.zabbix.com/zabbix-agent2-plugins/1/ubuntu jammy InRelease
Hit:6 https://repo.zabbix.com/zabbix/6.0/ubuntu jammy InRelease
Hit:7 http://archive.ubuntu.com/ubuntu jammy-backports InRelease
Fetched 257 kB in 1s (174 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
64 packages can be upgraded. Run 'apt list --upgradable' to see them.
root@qa-mongo3:~#
root@qa-mongo3:~# sudo apt install postgresql-16
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
E: Unable to locate package postgresql-16
root@qa-mongo3:~# ##Fix: Add PostgreSQL APT Repository^C
root@qa-mongo3:~# apt install wget gnupg2 ca-certificates -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
ca-certificates is already the newest version (20240203~22.04.1).
ca-certificates set to manually installed.
wget is already the newest version (1.21.2-2ubuntu1.1).
wget set to manually installed.
The following NEW packages will be installed:
  gnupg2
0 upgraded, 1 newly installed, 0 to remove and 64 not upgraded.
Need to get 5,544 B of archives.
After this operation, 52.2 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu jammy-updates/universe amd64 gnupg2 all 2.2.27-3ubuntu2.3 [5,544 B]
Fetched 5,544 B in 0s (14.4 kB/s)
Selecting previously unselected package gnupg2.
(Reading database ... 116292 files and directories currently installed.)
Preparing to unpack .../gnupg2_2.2.27-3ubuntu2.3_all.deb ...
Unpacking gnupg2 (2.2.27-3ubuntu2.3) ...
Setting up gnupg2 (2.2.27-3ubuntu2.3) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
Service restarts being deferred:
 systemctl restart ModemManager.service
 systemctl restart apache-htcacheclean.service
 systemctl restart apache2.service
 systemctl restart cron.service
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart irqbalance.service
 systemctl restart mongod.service
 systemctl restart multipathd.service
 systemctl restart mysql.service
 systemctl restart networkd-dispatcher.service
 systemctl restart open-vm-tools.service
 systemctl restart packagekit.service
 systemctl restart polkit.service
 systemctl restart rpcbind.service
 systemctl restart rsyslog.service
 systemctl restart snmpd.service
 systemctl restart ssh.service
 systemctl restart systemd-journald.service
 systemctl restart systemd-logind.service
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart systemd-networkd.service
 systemctl restart systemd-resolved.service
 systemctl restart systemd-timesyncd.service
 systemctl restart systemd-udevd.service
 systemctl restart udisks2.service
 systemctl restart unattended-upgrades.service
 systemctl restart upower.service
 systemctl restart user@1001.service
 systemctl restart vgauth.service
 systemctl restart zabbix-agent.service
 systemctl restart zabbix-agent2.service
 systemctl restart zabbix-server.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.


root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK
root@qa-mongo3:~# echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main"  > /etc/apt/sources.list.d/pgdg.list
root@qa-mongo3:~# apt update
Hit:1 http://archive.ubuntu.com/ubuntu jammy InRelease
Hit:2 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease
Hit:3 http://security.ubuntu.com/ubuntu jammy-security InRelease
Hit:4 http://archive.ubuntu.com/ubuntu jammy-updates InRelease
Get:5 http://apt.postgresql.org/pub/repos/apt jammy-pgdg InRelease [129 kB]
Hit:6 http://archive.ubuntu.com/ubuntu jammy-backports InRelease
Hit:7 https://repo.zabbix.com/zabbix-agent2-plugins/1/ubuntu jammy InRelease
Hit:8 https://repo.zabbix.com/zabbix/6.0/ubuntu jammy InRelease
Get:9 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 Packages [354 kB]
Fetched 484 kB in 2s (200 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
70 packages can be upgraded. Run 'apt list --upgradable' to see them.
W: http://apt.postgresql.org/pub/repos/apt/dists/jammy-pgdg/InRelease: Key is stored in legacy trusted.gpg keyring (/etc/apt/trusted.gpg), see the DEPRECATION section in apt-key(8) for details.
root@qa-mongo3:~# apt install postgresql-16
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libllvm15 libpq5 postgresql-client-16 postgresql-client-common postgresql-common postgresql-common-dev
Suggested packages:
  postgresql-doc-16
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libllvm15 postgresql-16 postgresql-client-16 postgresql-common-dev
The following packages will be upgraded:
  libpq5 postgresql-client-common postgresql-common
3 upgraded, 6 newly installed, 0 to remove and 67 not upgraded.
Need to get 46.2 MB of archives.
After this operation, 188 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://archive.ubuntu.com/ubuntu jammy/main amd64 libio-pty-perl amd64 1:1.15-2build2 [35.1 kB]
Get:2 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-common all 277.pgdg22.04+1 [183 kB]
Get:3 http://archive.ubuntu.com/ubuntu jammy/main amd64 libipc-run-perl all 20200505.0-1 [89.8 kB]
Get:4 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libllvm15 amd64 1:15.0.7-0ubuntu0.22.04.3 [25.4 MB]
Get:5 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-client-common all 277.pgdg22.04+1 [106 kB]
Get:6 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-common-dev all 277.pgdg22.04+1 [132 kB]
Get:7 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 libpq5 amd64 17.4-1.pgdg22.04+2 [226 kB]
Get:8 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-client-16 amd64 16.8-1.pgdg22.04+1 [1,913 kB]
Get:9 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-16 amd64 16.8-1.pgdg22.04+1 [18.1 MB]
Fetched 46.2 MB in 12s (3,985 kB/s)
Preconfiguring packages ...
(Reading database ... 116298 files and directories currently installed.)
Preparing to unpack .../0-postgresql-common_277.pgdg22.04+1_all.deb ...
Leaving 'diversion of /usr/bin/pg_config to /usr/bin/pg_config.libpq-dev by postgresql-common'
Unpacking postgresql-common (277.pgdg22.04+1) over (238) ...
Preparing to unpack .../1-postgresql-client-common_277.pgdg22.04+1_all.deb ...
Unpacking postgresql-client-common (277.pgdg22.04+1) over (238) ...
Selecting previously unselected package libio-pty-perl.
Preparing to unpack .../2-libio-pty-perl_1%3a1.15-2build2_amd64.deb ...
Unpacking libio-pty-perl (1:1.15-2build2) ...
Selecting previously unselected package libipc-run-perl.
Preparing to unpack .../3-libipc-run-perl_20200505.0-1_all.deb ...
Unpacking libipc-run-perl (20200505.0-1) ...
Selecting previously unselected package postgresql-common-dev.
Preparing to unpack .../4-postgresql-common-dev_277.pgdg22.04+1_all.deb ...
Unpacking postgresql-common-dev (277.pgdg22.04+1) ...
Selecting previously unselected package libllvm15:amd64.
Preparing to unpack .../5-libllvm15_1%3a15.0.7-0ubuntu0.22.04.3_amd64.deb ...
Unpacking libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Preparing to unpack .../6-libpq5_17.4-1.pgdg22.04+2_amd64.deb ...
Unpacking libpq5:amd64 (17.4-1.pgdg22.04+2) over (14.17-0ubuntu0.22.04.1) ...
Selecting previously unselected package postgresql-client-16.
Preparing to unpack .../7-postgresql-client-16_16.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-client-16 (16.8-1.pgdg22.04+1) ...
Selecting previously unselected package postgresql-16.
Preparing to unpack .../8-postgresql-16_16.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-16 (16.8-1.pgdg22.04+1) ...
Setting up postgresql-client-common (277.pgdg22.04+1) ...
Removing obsolete conffile /etc/postgresql-common/supported_versions ...
Setting up libio-pty-perl (1:1.15-2build2) ...
Setting up libpq5:amd64 (17.4-1.pgdg22.04+2) ...
Setting up libipc-run-perl (20200505.0-1) ...
Setting up libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Setting up postgresql-common-dev (277.pgdg22.04+1) ...
Setting up postgresql-client-16 (16.8-1.pgdg22.04+1) ...
Merging postmaster.1.gz alternatives into psql.1.gz link group ...
update-alternatives: updating alternative /usr/share/postgresql/14/man/man1/psql.1.gz because link group psql.1.gz has changed slave links
update-alternatives: using /usr/share/postgresql/16/man/man1/psql.1.gz to provide /usr/share/man/man1/psql.1.gz (psql.1.gz) in auto mode
Setting up postgresql-common (277.pgdg22.04+1) ...
Replacing config file /etc/postgresql-common/createcluster.conf with new version
Setting up postgresql-16 (16.8-1.pgdg22.04+1) ...
Processing triggers for man-db (2.10.2-1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.9) ...
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
Service restarts being deferred:
 systemctl restart ModemManager.service
 systemctl restart apache-htcacheclean.service
 systemctl restart apache2.service
 systemctl restart cron.service
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart irqbalance.service
 systemctl restart mongod.service
 systemctl restart multipathd.service
 systemctl restart mysql.service
 systemctl restart networkd-dispatcher.service
 systemctl restart open-vm-tools.service
 systemctl restart packagekit.service
 systemctl restart polkit.service
 systemctl restart rpcbind.service
 systemctl restart rsyslog.service
 systemctl restart snmpd.service
 systemctl restart ssh.service
 systemctl restart systemd-journald.service
 systemctl restart systemd-logind.service
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart systemd-networkd.service
 systemctl restart systemd-resolved.service
 systemctl restart systemd-timesyncd.service
 systemctl restart systemd-udevd.service
 systemctl restart udisks2.service
 systemctl restart unattended-upgrades.service
 systemctl restart upower.service
 systemctl restart user@1001.service
 systemctl restart vgauth.service
 systemctl restart zabbix-agent.service
 systemctl restart zabbix-agent2.service
 systemctl restart zabbix-server.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.

root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# apt list --installed | grep postgresql

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

postgresql-14/jammy-updates,jammy-security,now 14.17-0ubuntu0.22.04.1 amd64 [installed,upgradable to: 14.17-1.pgdg22.04+1]
postgresql-16/jammy-pgdg,now 16.8-1.pgdg22.04+1 amd64 [installed]
postgresql-client-14/jammy-updates,jammy-security,now 14.17-0ubuntu0.22.04.1 amd64 [installed,upgradable to: 14.17-1.pgdg22.04+1]
postgresql-client-16/jammy-pgdg,now 16.8-1.pgdg22.04+1 amd64 [installed,automatic]
postgresql-client-common/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-common-dev/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-common/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-contrib/jammy,now 14+238 all [installed]
postgresql/jammy,now 14+238 all [installed,upgradable to: 17+277.pgdg22.04+1]
zabbix-agent2-plugin-postgresql/zabbix,now 1:6.0.36-1+ubuntu22.04 amd64 [installed,upgradable to: 1:6.0.39-1+ubuntu22.04]
root@qa-mongo3:~#
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade \
  --old-datadir=/postgresql/data \
  --new-datadir=/postgresql/data16 \
  --old-bindir=/usr/lib/postgresql/14/bin \
  --new-bindir=/usr/lib/postgresql/16/bin \
  --logfile=/postgresql/logs/pg_upgrade.log

pg_upgrade: cannot be run as root
Failure, exiting
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade  --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin --logfile=/postgresql/logs/pg_upgrade.log

pg_upgrade: cannot be run as root
Failure, exiting
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade  --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin --logfile=/postgresql/logs/pg_upgrade.log
/usr/lib/postgresql/16/bin/pg_upgrade: unrecognized option '--logfile=/postgresql/logs/pg_upgrade.log'
Try "pg_upgrade --help" for more information.
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin -l /postgresql/logs/pg_upgrade.log
/usr/lib/postgresql/16/bin/pg_upgrade: invalid option -- 'l'
Try "pg_upgrade --help" for more information.
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade.log  2>&1
postgres@qa-mongo3:~$ sudo vi /etc/postgresql/16/main/postgresql.conf
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# ls -l /etc/postgresql/16/main/postgresql.conf
ls: cannot access '/etc/postgresql/16/main/postgresql.conf': No such file or directory
root@qa-mongo3:~# sudo mkdir -p /etc/postgresql/16/main
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/postgresql.conf.sample /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/pg_hba.conf.sample /etc/postgresql/16/main/pg_hba.conf
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/pg_ident.conf.sample /etc/postgresql/16/main/pg_ident.conf
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /etc/postgresql/14/main/pg_hba.conf /etc/postgresql/16/main/
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl status postgresql@16-main.service -l
× postgresql@16-main.service - PostgreSQL Cluster 16-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; disabled; vendor preset: enabled)
     Active: failed (Result: protocol) since Wed 2025-04-16 16:27:52 IST; 27s ago
    Process: 3205403 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect 16-main start (code=exited, status=1/FAILURE)
        CPU: 52ms

Apr 16 16:27:52 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
Apr 16 16:27:52 qa-mongo3 postgresql@16-main[3205403]: Error: Port conflict: another instance is already running on /var/run/postgresql with port 5432
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
Apr 16 16:27:52 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
root@qa-mongo3:~# sudo systemctl stop postgresql@14-main
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# systemctl status postgres
Unit postgres.service could not be found.
root@qa-mongo3:~# sudo systemctl status postgresql@14-main.service -l
○ postgresql@14-main.service - PostgreSQL Cluster 14-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; enabled-runtime; vendor preset: enabled)
     Active: inactive (dead) since Wed 2025-04-16 16:28:55 IST; 46s ago
    Process: 3205425 ExecStop=/usr/bin/pg_ctlcluster --skip-systemctl-redirect -m fast 14-main stop (code=exited, status=0/SUCCESS)
   Main PID: 3204008 (code=exited, status=0/SUCCESS)
        CPU: 831ms

Apr 16 16:09:25 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 14-main...
Apr 16 16:09:27 qa-mongo3 systemd[1]: Started PostgreSQL Cluster 14-main.
Apr 16 16:28:55 qa-mongo3 systemd[1]: Stopping PostgreSQL Cluster 14-main...
Apr 16 16:28:55 qa-mongo3 systemd[1]: postgresql@14-main.service: Deactivated successfully.
Apr 16 16:28:55 qa-mongo3 systemd[1]: Stopped PostgreSQL Cluster 14-main.
root@qa-mongo3:~# sudo journalctl -xeu postgresql@16-main.service
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877047.
Apr 16 16:27:52 qa-mongo3 postgresql@16-main[3205403]: Error: Port conflict: another instance is already running on /var/run/postgresql with port 5432
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:27:52 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877047 and the job result is failed.
Apr 16 16:29:11 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877131.
Apr 16 16:29:11 qa-mongo3 postgresql@16-main[3205435]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgre>
Apr 16 16:29:11 qa-mongo3 postgresql@16-main[3205435]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:29:11 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:29:11 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:29:11 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877131 and the job result is failed.

root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_retry.log 2>&1
root@qa-mongo3:~#
root@qa-mongo3:~# sudo pg_createcluster 16 main --datadir=/postgresql/data16 --start
Error: cluster configuration already exists
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /etc/postgresql/14/main/pg_hba.conf /etc/postgresql/16/main/
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# ls -l /postgresql/data16
total 0
root@qa-mongo3:~# grep data_directory /etc/postgresql/16/main/postgresql.conf
data_directory = '/postgresql/data16'           # use data in another directory
root@qa-mongo3:~# ls -lh /etc/postgresql/16/main/postgresql.conf
-rw-r--r-- 1 root root 30K Apr 16 16:27 /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo journalctl -xeu postgresql@16-main.service | tail -n 30
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877131 and the job result is failed.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877215.
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgresql-16-main.log -s -o -c unix_socket_directories="/var/run/postgresql" -c config_file="/etc/postgresql/16/main/postgresql.conf" -c hba_file="/etc/postgresql/16/main/pg_hba.conf" -c ident_file="/etc/postgresql/16/main/pg_ident.conf" -c external_pid_file="/var/run/postgresql/16-main.pid"  exited with status 1: No such file or directory
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877215 and the job result is failed.
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo systemctl status postgresql@16-main
× postgresql@16-main.service - PostgreSQL Cluster 16-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; disabled; vendor preset: enabled)
     Active: failed (Result: protocol) since Wed 2025-04-16 16:35:04 IST; 2min 7s ago
    Process: 3205550 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect 16-main start (code=exited, status=1/FAILURE)
        CPU: 56ms

Apr 16 16:35:04 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgre>
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.

root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~#
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ ls -l /postgresql/data16
total 4
drwxr-x--- 3 postgres postgres 4096 Apr 16 16:38 pg_upgrade_output.d
postgres@qa-mongo3:~$ ls -l /postgresql/data16
total 4
drwxr-x--- 3 postgres postgres 4096 Apr 16 16:38 pg_upgrade_output.d
postgres@qa-mongo3:~$ cat /postgresql/logs/pg_upgrade_final.log | tail -n 40

could not open version file "/postgresql/data16/PG_VERSION": No such file or directory
Failure, exiting
postgres@qa-mongo3:~$ sudo systemctl stop postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo -u postgres /usr/lib/postgresql/16/bin/initdb -D /postgresql/data16
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

creating directory /postgresql/data16 ... initdb: error: could not create directory "/postgresql/data16": Permission denied
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$ sudo systemctl start postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# sudo chown -R postgres:postgres /postgresql
root@qa-mongo3:~# sudo chmod 700 /postgresql
root@qa-mongo3:~# ls -ld /postgresql
drwx------ 4 postgres postgres 4096 Apr 16 16:41 /postgresql
root@qa-mongo3:~# sudo -u postgres /usr/lib/postgresql/16/bin/initdb -D /postgresql/data16
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

creating directory /postgresql/data16 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Asia/Kolkata
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /usr/lib/postgresql/16/bin/pg_ctl -D /postgresql/data16 -l logfile start

root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$ sudo systemctl start postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl start postgresql@16-main

root@qa-mongo3:~# sudo -u postgres psql -c "SELECT version();"
                                                              version
-----------------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 16.8 (Ubuntu 16.8-1.pgdg22.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0, 64-bit
(1 row)

root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ psql
psql (16.8 (Ubuntu 16.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# \l
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 grafana   | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/postgres         +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres+
           |          |          |                 |             |             |            |           | grafana=CTc/postgres
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | postgres=CTc/postgres+
           |          |          |                 |             |             |            |           | =c/postgres
(4 rows)

postgres=# \c grafana
You are now connected to database "grafana" as user "postgres".
grafana=# \dt
                  List of relations
 Schema |          Name           | Type  |  Owner
--------+-------------------------+-------+----------
 public | db_size_report_prod     | table | postgres
 public | db_size_report_uat      | table | postgres
 public | new_db_size_report_prod | table | postgres
 public | new_db_size_report_uat  | table | postgres
(4 rows)

grafana=# select * from db_size_report_prod;
grafana=#
grafana=#
grafana=#
grafana=#
grafana=# \q
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
======= =============
====clean 14=====
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# psql -V
psql (PostgreSQL) 14.17 (Ubuntu 14.17-0ubuntu0.22.04.1)
root@qa-mongo3:~#
root@qa-mongo3:~# pg_dumpall > /tmp/pg14_full_backup.sql
-bash: /tmp/pg14_full_backup.sql: Permission denied
root@qa-mongo3:~#
root@qa-mongo3:~# pg_dumpall > /tmp/pg14_full_backup_16april25.sql
pg_dumpall: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  role "root" does not exist
root@qa-mongo3:~# sudo -u postgres pg_dumpall > /tmp/pg14_full_backup_16april25.sql
could not change directory to "/root": Permission denied
root@qa-mongo3:~# pg_dumpall -U postgres > /tmp/pg14_full_backup_16april-25.sql
pg_dumpall: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "postgres"
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ pg_dumpall > /tmp/pg14_full_backup_16april25.sql
-bash: /tmp/pg14_full_backup_16april25.sql: Permission denied
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup.sql
-rw-rw-r-- 1 postgres postgres 16M Apr 16 15:55 /tmp/pg14_full_backup.sql
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup_16april25.sql
-rw-r--r-- 1 root root 16M Apr 16 16:01 /tmp/pg14_full_backup_16april25.sql
postgres@qa-mongo3:~$ ls -lh /tmp/pg14_full_backup_16april-25.sql
-rw-r--r-- 1 root root 0 Apr 16 16:02 /tmp/pg14_full_backup_16april-25.sql
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ sudo cp -av /etc/postgresql/14/main/postgresql.conf /etc/postgresql/14/main/postgresql.conf.bak
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/postgresql.conf /etc/postgresql/14/main/postgresql.conf.bak
'/etc/postgresql/14/main/postgresql.conf' -> '/etc/postgresql/14/main/postgresql.conf.bak'
root@qa-mongo3:~# ls -lh  /etc/postgresql/14/main/postgresql.conf.bak
-rw-r--r-- 1 postgres postgres 29K Mar 13 16:33 /etc/postgresql/14/main/postgresql.conf.bak
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/pg_hba.conf     /etc/postgresql/14/main/pg_hba.conf.bak
'/etc/postgresql/14/main/pg_hba.conf' -> '/etc/postgresql/14/main/pg_hba.conf.bak'
root@qa-mongo3:~# sudo cp -av /etc/postgresql/14/main/pg_ident.conf   /etc/postgresql/14/main/pg_ident.conf.bak
'/etc/postgresql/14/main/pg_ident.conf' -> '/etc/postgresql/14/main/pg_ident.conf.bak'
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl stop postgresql
root@qa-mongo3:~#
root@qa-mongo3:~# sudo apt update
Get:1 http://security.ubuntu.com/ubuntu jammy-security InRelease [129 kB]
Hit:2 http://archive.ubuntu.com/ubuntu jammy InRelease
Hit:3 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease
Get:4 http://archive.ubuntu.com/ubuntu jammy-updates InRelease [128 kB]
Hit:5 https://repo.zabbix.com/zabbix-agent2-plugins/1/ubuntu jammy InRelease
Hit:6 https://repo.zabbix.com/zabbix/6.0/ubuntu jammy InRelease
Hit:7 http://archive.ubuntu.com/ubuntu jammy-backports InRelease
Fetched 257 kB in 1s (174 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
64 packages can be upgraded. Run 'apt list --upgradable' to see them.
root@qa-mongo3:~#
root@qa-mongo3:~# sudo apt install postgresql-16
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
E: Unable to locate package postgresql-16
root@qa-mongo3:~# ##Fix: Add PostgreSQL APT Repository^C
root@qa-mongo3:~# apt install wget gnupg2 ca-certificates -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
ca-certificates is already the newest version (20240203~22.04.1).
ca-certificates set to manually installed.
wget is already the newest version (1.21.2-2ubuntu1.1).
wget set to manually installed.
The following NEW packages will be installed:
  gnupg2
0 upgraded, 1 newly installed, 0 to remove and 64 not upgraded.
Need to get 5,544 B of archives.
After this operation, 52.2 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu jammy-updates/universe amd64 gnupg2 all 2.2.27-3ubuntu2.3 [5,544 B]
Fetched 5,544 B in 0s (14.4 kB/s)
Selecting previously unselected package gnupg2.
(Reading database ... 116292 files and directories currently installed.)
Preparing to unpack .../gnupg2_2.2.27-3ubuntu2.3_all.deb ...
Unpacking gnupg2 (2.2.27-3ubuntu2.3) ...
Setting up gnupg2 (2.2.27-3ubuntu2.3) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
Service restarts being deferred:
 systemctl restart ModemManager.service
 systemctl restart apache-htcacheclean.service
 systemctl restart apache2.service
 systemctl restart cron.service
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart irqbalance.service
 systemctl restart mongod.service
 systemctl restart multipathd.service
 systemctl restart mysql.service
 systemctl restart networkd-dispatcher.service
 systemctl restart open-vm-tools.service
 systemctl restart packagekit.service
 systemctl restart polkit.service
 systemctl restart rpcbind.service
 systemctl restart rsyslog.service
 systemctl restart snmpd.service
 systemctl restart ssh.service
 systemctl restart systemd-journald.service
 systemctl restart systemd-logind.service
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart systemd-networkd.service
 systemctl restart systemd-resolved.service
 systemctl restart systemd-timesyncd.service
 systemctl restart systemd-udevd.service
 systemctl restart udisks2.service
 systemctl restart unattended-upgrades.service
 systemctl restart upower.service
 systemctl restart user@1001.service
 systemctl restart vgauth.service
 systemctl restart zabbix-agent.service
 systemctl restart zabbix-agent2.service
 systemctl restart zabbix-server.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.


root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK
root@qa-mongo3:~# echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main"  > /etc/apt/sources.list.d/pgdg.list
root@qa-mongo3:~# apt update
Hit:1 http://archive.ubuntu.com/ubuntu jammy InRelease
Hit:2 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease
Hit:3 http://security.ubuntu.com/ubuntu jammy-security InRelease
Hit:4 http://archive.ubuntu.com/ubuntu jammy-updates InRelease
Get:5 http://apt.postgresql.org/pub/repos/apt jammy-pgdg InRelease [129 kB]
Hit:6 http://archive.ubuntu.com/ubuntu jammy-backports InRelease
Hit:7 https://repo.zabbix.com/zabbix-agent2-plugins/1/ubuntu jammy InRelease
Hit:8 https://repo.zabbix.com/zabbix/6.0/ubuntu jammy InRelease
Get:9 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 Packages [354 kB]
Fetched 484 kB in 2s (200 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
70 packages can be upgraded. Run 'apt list --upgradable' to see them.
W: http://apt.postgresql.org/pub/repos/apt/dists/jammy-pgdg/InRelease: Key is stored in legacy trusted.gpg keyring (/etc/apt/trusted.gpg), see the DEPRECATION section in apt-key(8) for details.
root@qa-mongo3:~# apt install postgresql-16
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libllvm15 libpq5 postgresql-client-16 postgresql-client-common postgresql-common postgresql-common-dev
Suggested packages:
  postgresql-doc-16
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libllvm15 postgresql-16 postgresql-client-16 postgresql-common-dev
The following packages will be upgraded:
  libpq5 postgresql-client-common postgresql-common
3 upgraded, 6 newly installed, 0 to remove and 67 not upgraded.
Need to get 46.2 MB of archives.
After this operation, 188 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://archive.ubuntu.com/ubuntu jammy/main amd64 libio-pty-perl amd64 1:1.15-2build2 [35.1 kB]
Get:2 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-common all 277.pgdg22.04+1 [183 kB]
Get:3 http://archive.ubuntu.com/ubuntu jammy/main amd64 libipc-run-perl all 20200505.0-1 [89.8 kB]
Get:4 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libllvm15 amd64 1:15.0.7-0ubuntu0.22.04.3 [25.4 MB]
Get:5 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-client-common all 277.pgdg22.04+1 [106 kB]
Get:6 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-common-dev all 277.pgdg22.04+1 [132 kB]
Get:7 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 libpq5 amd64 17.4-1.pgdg22.04+2 [226 kB]
Get:8 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-client-16 amd64 16.8-1.pgdg22.04+1 [1,913 kB]
Get:9 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-16 amd64 16.8-1.pgdg22.04+1 [18.1 MB]
Fetched 46.2 MB in 12s (3,985 kB/s)
Preconfiguring packages ...
(Reading database ... 116298 files and directories currently installed.)
Preparing to unpack .../0-postgresql-common_277.pgdg22.04+1_all.deb ...
Leaving 'diversion of /usr/bin/pg_config to /usr/bin/pg_config.libpq-dev by postgresql-common'
Unpacking postgresql-common (277.pgdg22.04+1) over (238) ...
Preparing to unpack .../1-postgresql-client-common_277.pgdg22.04+1_all.deb ...
Unpacking postgresql-client-common (277.pgdg22.04+1) over (238) ...
Selecting previously unselected package libio-pty-perl.
Preparing to unpack .../2-libio-pty-perl_1%3a1.15-2build2_amd64.deb ...
Unpacking libio-pty-perl (1:1.15-2build2) ...
Selecting previously unselected package libipc-run-perl.
Preparing to unpack .../3-libipc-run-perl_20200505.0-1_all.deb ...
Unpacking libipc-run-perl (20200505.0-1) ...
Selecting previously unselected package postgresql-common-dev.
Preparing to unpack .../4-postgresql-common-dev_277.pgdg22.04+1_all.deb ...
Unpacking postgresql-common-dev (277.pgdg22.04+1) ...
Selecting previously unselected package libllvm15:amd64.
Preparing to unpack .../5-libllvm15_1%3a15.0.7-0ubuntu0.22.04.3_amd64.deb ...
Unpacking libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Preparing to unpack .../6-libpq5_17.4-1.pgdg22.04+2_amd64.deb ...
Unpacking libpq5:amd64 (17.4-1.pgdg22.04+2) over (14.17-0ubuntu0.22.04.1) ...
Selecting previously unselected package postgresql-client-16.
Preparing to unpack .../7-postgresql-client-16_16.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-client-16 (16.8-1.pgdg22.04+1) ...
Selecting previously unselected package postgresql-16.
Preparing to unpack .../8-postgresql-16_16.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-16 (16.8-1.pgdg22.04+1) ...
Setting up postgresql-client-common (277.pgdg22.04+1) ...
Removing obsolete conffile /etc/postgresql-common/supported_versions ...
Setting up libio-pty-perl (1:1.15-2build2) ...
Setting up libpq5:amd64 (17.4-1.pgdg22.04+2) ...
Setting up libipc-run-perl (20200505.0-1) ...
Setting up libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Setting up postgresql-common-dev (277.pgdg22.04+1) ...
Setting up postgresql-client-16 (16.8-1.pgdg22.04+1) ...
Merging postmaster.1.gz alternatives into psql.1.gz link group ...
update-alternatives: updating alternative /usr/share/postgresql/14/man/man1/psql.1.gz because link group psql.1.gz has changed slave links
update-alternatives: using /usr/share/postgresql/16/man/man1/psql.1.gz to provide /usr/share/man/man1/psql.1.gz (psql.1.gz) in auto mode
Setting up postgresql-common (277.pgdg22.04+1) ...
Replacing config file /etc/postgresql-common/createcluster.conf with new version
Setting up postgresql-16 (16.8-1.pgdg22.04+1) ...
Processing triggers for man-db (2.10.2-1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.9) ...
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
Service restarts being deferred:
 systemctl restart ModemManager.service
 systemctl restart apache-htcacheclean.service
 systemctl restart apache2.service
 systemctl restart cron.service
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart irqbalance.service
 systemctl restart mongod.service
 systemctl restart multipathd.service
 systemctl restart mysql.service
 systemctl restart networkd-dispatcher.service
 systemctl restart open-vm-tools.service
 systemctl restart packagekit.service
 systemctl restart polkit.service
 systemctl restart rpcbind.service
 systemctl restart rsyslog.service
 systemctl restart snmpd.service
 systemctl restart ssh.service
 systemctl restart systemd-journald.service
 systemctl restart systemd-logind.service
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart systemd-networkd.service
 systemctl restart systemd-resolved.service
 systemctl restart systemd-timesyncd.service
 systemctl restart systemd-udevd.service
 systemctl restart udisks2.service
 systemctl restart unattended-upgrades.service
 systemctl restart upower.service
 systemctl restart user@1001.service
 systemctl restart vgauth.service
 systemctl restart zabbix-agent.service
 systemctl restart zabbix-agent2.service
 systemctl restart zabbix-server.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.

root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# apt list --installed | grep postgresql

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

postgresql-14/jammy-updates,jammy-security,now 14.17-0ubuntu0.22.04.1 amd64 [installed,upgradable to: 14.17-1.pgdg22.04+1]
postgresql-16/jammy-pgdg,now 16.8-1.pgdg22.04+1 amd64 [installed]
postgresql-client-14/jammy-updates,jammy-security,now 14.17-0ubuntu0.22.04.1 amd64 [installed,upgradable to: 14.17-1.pgdg22.04+1]
postgresql-client-16/jammy-pgdg,now 16.8-1.pgdg22.04+1 amd64 [installed,automatic]
postgresql-client-common/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-common-dev/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-common/jammy-pgdg,now 277.pgdg22.04+1 all [installed,automatic]
postgresql-contrib/jammy,now 14+238 all [installed]
postgresql/jammy,now 14+238 all [installed,upgradable to: 17+277.pgdg22.04+1]
zabbix-agent2-plugin-postgresql/zabbix,now 1:6.0.36-1+ubuntu22.04 amd64 [installed,upgradable to: 1:6.0.39-1+ubuntu22.04]
root@qa-mongo3:~#
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade \
  --old-datadir=/postgresql/data \
  --new-datadir=/postgresql/data16 \
  --old-bindir=/usr/lib/postgresql/14/bin \
  --new-bindir=/usr/lib/postgresql/16/bin \
  --logfile=/postgresql/logs/pg_upgrade.log

pg_upgrade: cannot be run as root
Failure, exiting
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade  --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin --logfile=/postgresql/logs/pg_upgrade.log

pg_upgrade: cannot be run as root
Failure, exiting
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade  --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin --logfile=/postgresql/logs/pg_upgrade.log
/usr/lib/postgresql/16/bin/pg_upgrade: unrecognized option '--logfile=/postgresql/logs/pg_upgrade.log'
Try "pg_upgrade --help" for more information.
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin -l /postgresql/logs/pg_upgrade.log
/usr/lib/postgresql/16/bin/pg_upgrade: invalid option -- 'l'
Try "pg_upgrade --help" for more information.
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade.log  2>&1
postgres@qa-mongo3:~$ sudo vi /etc/postgresql/16/main/postgresql.conf
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# ls -l /etc/postgresql/16/main/postgresql.conf
ls: cannot access '/etc/postgresql/16/main/postgresql.conf': No such file or directory
root@qa-mongo3:~# sudo mkdir -p /etc/postgresql/16/main
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/postgresql.conf.sample /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/pg_hba.conf.sample /etc/postgresql/16/main/pg_hba.conf
root@qa-mongo3:~# sudo cp /usr/share/postgresql/16/pg_ident.conf.sample /etc/postgresql/16/main/pg_ident.conf
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /etc/postgresql/14/main/pg_hba.conf /etc/postgresql/16/main/
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl status postgresql@16-main.service -l
× postgresql@16-main.service - PostgreSQL Cluster 16-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; disabled; vendor preset: enabled)
     Active: failed (Result: protocol) since Wed 2025-04-16 16:27:52 IST; 27s ago
    Process: 3205403 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect 16-main start (code=exited, status=1/FAILURE)
        CPU: 52ms

Apr 16 16:27:52 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
Apr 16 16:27:52 qa-mongo3 postgresql@16-main[3205403]: Error: Port conflict: another instance is already running on /var/run/postgresql with port 5432
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
Apr 16 16:27:52 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
root@qa-mongo3:~# sudo systemctl stop postgresql@14-main
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# systemctl status postgres
Unit postgres.service could not be found.
root@qa-mongo3:~# sudo systemctl status postgresql@14-main.service -l
○ postgresql@14-main.service - PostgreSQL Cluster 14-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; enabled-runtime; vendor preset: enabled)
     Active: inactive (dead) since Wed 2025-04-16 16:28:55 IST; 46s ago
    Process: 3205425 ExecStop=/usr/bin/pg_ctlcluster --skip-systemctl-redirect -m fast 14-main stop (code=exited, status=0/SUCCESS)
   Main PID: 3204008 (code=exited, status=0/SUCCESS)
        CPU: 831ms

Apr 16 16:09:25 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 14-main...
Apr 16 16:09:27 qa-mongo3 systemd[1]: Started PostgreSQL Cluster 14-main.
Apr 16 16:28:55 qa-mongo3 systemd[1]: Stopping PostgreSQL Cluster 14-main...
Apr 16 16:28:55 qa-mongo3 systemd[1]: postgresql@14-main.service: Deactivated successfully.
Apr 16 16:28:55 qa-mongo3 systemd[1]: Stopped PostgreSQL Cluster 14-main.
root@qa-mongo3:~# sudo journalctl -xeu postgresql@16-main.service
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877047.
Apr 16 16:27:52 qa-mongo3 postgresql@16-main[3205403]: Error: Port conflict: another instance is already running on /var/run/postgresql with port 5432
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:27:52 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:27:52 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877047 and the job result is failed.
Apr 16 16:29:11 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877131.
Apr 16 16:29:11 qa-mongo3 postgresql@16-main[3205435]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgre>
Apr 16 16:29:11 qa-mongo3 postgresql@16-main[3205435]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:29:11 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:29:11 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:29:11 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877131 and the job result is failed.

root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~# /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_retry.log 2>&1
root@qa-mongo3:~#
root@qa-mongo3:~# sudo pg_createcluster 16 main --datadir=/postgresql/data16 --start
Error: cluster configuration already exists
root@qa-mongo3:~# sudo vi /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo cp /etc/postgresql/14/main/pg_hba.conf /etc/postgresql/16/main/
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# ls -l /postgresql/data16
total 0
root@qa-mongo3:~# grep data_directory /etc/postgresql/16/main/postgresql.conf
data_directory = '/postgresql/data16'           # use data in another directory
root@qa-mongo3:~# ls -lh /etc/postgresql/16/main/postgresql.conf
-rw-r--r-- 1 root root 30K Apr 16 16:27 /etc/postgresql/16/main/postgresql.conf
root@qa-mongo3:~# sudo journalctl -xeu postgresql@16-main.service | tail -n 30
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877131 and the job result is failed.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
░░ Subject: A start job for unit postgresql@16-main.service has begun execution
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has begun execution.
░░
░░ The job identifier is 877215.
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgresql-16-main.log -s -o -c unix_socket_directories="/var/run/postgresql" -c config_file="/etc/postgresql/16/main/postgresql.conf" -c hba_file="/etc/postgresql/16/main/pg_hba.conf" -c ident_file="/etc/postgresql/16/main/pg_ident.conf" -c external_pid_file="/var/run/postgresql/16-main.pid"  exited with status 1: No such file or directory
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
░░ Subject: Unit failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ The unit postgresql@16-main.service has entered the 'failed' state with result 'protocol'.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.
░░ Subject: A start job for unit postgresql@16-main.service has failed
░░ Defined-By: systemd
░░ Support: http://www.ubuntu.com/support
░░
░░ A start job for unit postgresql@16-main.service has finished with a failure.
░░
░░ The job identifier is 877215 and the job result is failed.
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~#
root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo systemctl status postgresql@16-main
× postgresql@16-main.service - PostgreSQL Cluster 16-main
     Loaded: loaded (/lib/systemd/system/postgresql@.service; disabled; vendor preset: enabled)
     Active: failed (Result: protocol) since Wed 2025-04-16 16:35:04 IST; 2min 7s ago
    Process: 3205550 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect 16-main start (code=exited, status=1/FAILURE)
        CPU: 56ms

Apr 16 16:35:04 qa-mongo3 systemd[1]: Starting PostgreSQL Cluster 16-main...
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: Error: /usr/lib/postgresql/16/bin/pg_ctl /usr/lib/postgresql/16/bin/pg_ctl start -D /postgresql/data16 -l /var/log/postgresql/postgre>
Apr 16 16:35:04 qa-mongo3 postgresql@16-main[3205550]: pg_ctl: directory "/postgresql/data16" is not a database cluster directory
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Can't open PID file /run/postgresql/16-main.pid (yet?) after start: Operation not permitted
Apr 16 16:35:04 qa-mongo3 systemd[1]: postgresql@16-main.service: Failed with result 'protocol'.
Apr 16 16:35:04 qa-mongo3 systemd[1]: Failed to start PostgreSQL Cluster 16-main.

root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo mkdir -p /postgresql/data16
root@qa-mongo3:~# sudo chown postgres:postgres /postgresql/data16
root@qa-mongo3:~#
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ ls -l /postgresql/data16
total 4
drwxr-x--- 3 postgres postgres 4096 Apr 16 16:38 pg_upgrade_output.d
postgres@qa-mongo3:~$ ls -l /postgresql/data16
total 4
drwxr-x--- 3 postgres postgres 4096 Apr 16 16:38 pg_upgrade_output.d
postgres@qa-mongo3:~$ cat /postgresql/logs/pg_upgrade_final.log | tail -n 40

could not open version file "/postgresql/data16/PG_VERSION": No such file or directory
Failure, exiting
postgres@qa-mongo3:~$ sudo systemctl stop postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl stop postgresql@16-main
root@qa-mongo3:~# sudo rm -rf /postgresql/data16
root@qa-mongo3:~# sudo -u postgres /usr/lib/postgresql/16/bin/initdb -D /postgresql/data16
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

creating directory /postgresql/data16 ... initdb: error: could not create directory "/postgresql/data16": Permission denied
root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$ sudo systemctl start postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl start postgresql@16-main
Job for postgresql@16-main.service failed because the service did not take the steps required by its unit configuration.
See "systemctl status postgresql@16-main.service" and "journalctl -xeu postgresql@16-main.service" for details.
root@qa-mongo3:~# sudo chown -R postgres:postgres /postgresql
root@qa-mongo3:~# sudo chmod 700 /postgresql
root@qa-mongo3:~# ls -ld /postgresql
drwx------ 4 postgres postgres 4096 Apr 16 16:41 /postgresql
root@qa-mongo3:~# sudo -u postgres /usr/lib/postgresql/16/bin/initdb -D /postgresql/data16
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

creating directory /postgresql/data16 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Asia/Kolkata
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /usr/lib/postgresql/16/bin/pg_ctl -D /postgresql/data16 -l logfile start

root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ /usr/lib/postgresql/16/bin/pg_upgrade --old-datadir=/postgresql/data --new-datadir=/postgresql/data16 --old-bindir=/usr/lib/postgresql/14/bin --new-bindir=/usr/lib/postgresql/16/bin > /postgresql/logs/pg_upgrade_final.log 2>&1
postgres@qa-mongo3:~$ sudo systemctl start postgresql@16-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl start postgresql@16-main

root@qa-mongo3:~# sudo -u postgres psql -c "SELECT version();"
                                                              version
-----------------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 16.8 (Ubuntu 16.8-1.pgdg22.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0, 64-bit
(1 row)

root@qa-mongo3:~# sudo -i -u postgres
postgres@qa-mongo3:~$ psql
psql (16.8 (Ubuntu 16.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# \l
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 grafana   | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/postgres         +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres+
           |          |          |                 |             |             |            |           | grafana=CTc/postgres
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | postgres=CTc/postgres+
           |          |          |                 |             |             |            |           | =c/postgres
(4 rows)

postgres=# \c grafana
You are now connected to database "grafana" as user "postgres".
grafana=# \dt
                  List of relations
 Schema |          Name           | Type  |  Owner
--------+-------------------------+-------+----------
 public | db_size_report_prod     | table | postgres
 public | db_size_report_uat      | table | postgres
 public | new_db_size_report_prod | table | postgres
 public | new_db_size_report_uat  | table | postgres
(4 rows)

grafana=# select * from db_size_report_prod;
grafana=#
grafana=#
grafana=#
grafana=#
grafana=# \q
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$
postgres@qa-mongo3:~$ # Final Cleanup (PostgreSQL 14 Uninstall) ^C
postgres@qa-mongo3:~$ sudo systemctl stop postgresql@14-main
[sudo] password for postgres:
sudo: a password is required
postgres@qa-mongo3:~$ exit
logout
root@qa-mongo3:~# sudo systemctl stop postgresql@14-main
root@qa-mongo3:~# sudo apt purge postgresql-14 postgresql-client-14 -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  libllvm14
Use 'sudo apt autoremove' to remove it.
The following additional packages will be installed:
  postgresql postgresql-17 postgresql-client-17
Suggested packages:
  postgresql-doc postgresql-doc-17
The following packages will be REMOVED:
  postgresql-14* postgresql-client-14* postgresql-contrib*
The following NEW packages will be installed:
  postgresql-17 postgresql-client-17
The following packages will be upgraded:
  postgresql
1 upgraded, 2 newly installed, 3 to remove and 64 not upgraded.
Need to get 20.9 MB of archives.
After this operation, 23.3 MB of additional disk space will be used.
Get:1 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-client-17 amd64 17.4-1.pgdg22.04+2 [2,020 kB]
Get:2 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql-17 amd64 17.4-1.pgdg22.04+2 [18.8 MB]
Get:3 http://apt.postgresql.org/pub/repos/apt jammy-pgdg/main amd64 postgresql all 17+277.pgdg22.04+1 [74.2 kB]
Fetched 20.9 MB in 10s (2,051 kB/s)
Preconfiguring packages ...
Selecting previously unselected package postgresql-client-17.
(Reading database ... 118463 files and directories currently installed.)
Preparing to unpack .../postgresql-client-17_17.4-1.pgdg22.04+2_amd64.deb ...
Unpacking postgresql-client-17 (17.4-1.pgdg22.04+2) ...
Selecting previously unselected package postgresql-17.
Preparing to unpack .../postgresql-17_17.4-1.pgdg22.04+2_amd64.deb ...
Unpacking postgresql-17 (17.4-1.pgdg22.04+2) ...
Preparing to unpack .../postgresql_17+277.pgdg22.04+1_all.deb ...
Unpacking postgresql (17+277.pgdg22.04+1) over (14+238) ...
(Reading database ... 120551 files and directories currently installed.)
Removing postgresql-contrib (14+238) ...
Removing postgresql-14 (14.17-0ubuntu0.22.04.1) ...
Removing postgresql-client-14 (14.17-0ubuntu0.22.04.1) ...
Setting up postgresql-client-17 (17.4-1.pgdg22.04+2) ...
update-alternatives: using /usr/share/postgresql/17/man/man1/psql.1.gz to provide /usr/share/man/man1/psql.1.gz (psql.1.gz) in auto mode
Setting up postgresql-17 (17.4-1.pgdg22.04+2) ...
Setting up postgresql (17+277.pgdg22.04+1) ...
Processing triggers for postgresql-common (277.pgdg22.04+1) ...
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
Removing obsolete dictionary files:
(Reading database ... 118902 files and directories currently installed.)
Purging configuration files for postgresql-14 (14.17-0ubuntu0.22.04.1) ...
Dropping cluster main...
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
Service restarts being deferred:
 systemctl restart ModemManager.service
 systemctl restart apache-htcacheclean.service
 systemctl restart apache2.service
 systemctl restart cron.service
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart irqbalance.service
 systemctl restart mongod.service
 systemctl restart multipathd.service
 systemctl restart mysql.service
 systemctl restart networkd-dispatcher.service
 systemctl restart open-vm-tools.service
 systemctl restart packagekit.service
 systemctl restart polkit.service
 systemctl restart rpcbind.service
 systemctl restart rsyslog.service
 systemctl restart snmpd.service
 systemctl restart ssh.service
 systemctl restart systemd-journald.service
 systemctl restart systemd-logind.service
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart systemd-networkd.service
 systemctl restart systemd-resolved.service
 systemctl restart systemd-timesyncd.service
 systemctl restart systemd-udevd.service
 systemctl restart udisks2.service
 systemctl restart unattended-upgrades.service
 systemctl restart upower.service
 systemctl restart user@1001.service
 systemctl restart vgauth.service
 systemctl restart zabbix-agent.service
 systemctl restart zabbix-agent2.service
 systemctl restart zabbix-server.service
No containers need to be restarted.
No user sessions are running outdated binaries.
No VM guests are running outdated hypervisor (qemu) binaries on this host.
root@qa-mongo3:~# sudo apt autoremove --purge -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages will be REMOVED:
  libllvm14*
0 upgraded, 0 newly installed, 1 to remove and 64 not upgraded.
After this operation, 109 MB disk space will be freed.
(Reading database ... 118902 files and directories currently installed.)
Removing libllvm14:amd64 (1:14.0.0-1ubuntu1.1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.9) ...
root@qa-mongo3:~# sudo rm -rf /postgresql/data
root@qa-mongo3:~#

